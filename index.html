<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>EQ nback</title>
</head>

<body>
  <div id="view"></div>
</body>

<script>

/**
 * Views:
 *  Before game screen
 *    Info about n back level [done]
 *    Play button [done]
 *    Statistics from previous game
 *    Custom settings [partially]
 *
 *  Game screen
 *    Just pictures of emotions. [done]
 * */

  const beforeGameScreen = `<div>
    N-back level:  <input type="number" id="nBackLevel" value="2" /><button onclick="setNbackLevel()">Set it</button></br>
    <button onclick="startGame()">Play</button><br />
    Last game success rate:
    <div id="lastGameSuccessRate" />
  </div>`;

  const gameScreen = `<img 
    id="expression"
    src="./files/1.jpg" 
    alt="Expression" 
    style="
      display:block;
      text-align:center;
      "
  />`;

  
  // const expressionImageSrc = document.getElementById("expression").src;
  // console.log(expressionImageSrc);

  /** Emotinal n back consists of:
   *  nBackLevel - Number of steps to past the person playing game must remember
   *  delayBetweenSteps - Delay between steps in milliseconds
   *  numberOfStepsOnGame - number of steps which one game consists of
   *
   */

  // Tracking history of faces expressions in time.
  var stepsHistory = [];
  const gamesHistory = [];
  var delayBetweenSteps = 2000;
  var nBackLevel = 2;
  var numberOfStepsToGameEnd = 10;
  var gameInterval;

  

  const setNbackLevel = function() {
    nBackLevel = document.getElementById("nBackLevel").value;
  };

  const setView = function (screen) {
    document.getElementById("view").innerHTML = screen;
  }

  const setLastGameSuccessRate = () => {
    console.log('here', gamesHistory.length);
    gamesHistory.length > 0 && (() => {
      const lastGameSteps = gamesHistory[gamesHistory.length - 1];
      let numberOfSuccessfullTurns = 0;
      let numberOfUnsuccesfullTurns = 0;
      
      lastGameSteps.forEach(({ evaluation }) => 
        (evaluation !== "undefined" && 
          (evaluation === true && numberOfSuccessfullTurns++) || 
          (evaluation === false && numberOfUnsuccesfullTurns++)
        )
      )
      console.log(numberOfSuccessfullTurns, numberOfUnsuccesfullTurns);
      document.getElementById("lastGameSuccessRate").innerHTML = `${((numberOfSuccessfullTurns / numberOfUnsuccesfullTurns) * 100) / 2} %`;

    })();
  }

  setView(beforeGameScreen);


  const startGame = () => {
    var actualNumberOfStepsToGameEnd = numberOfStepsToGameEnd;
    stepsHistory = [];
    setView(gameScreen);
    // Changing images of expressions
    var gameInterval = setInterval(
      () =>  {
        let pickedExpressionImage = `${Math.floor(Math.random() * 8) + 1}.jpg`
        document.getElementById("expression").src = `./files/${pickedExpressionImage}`
        stepsHistory.push({ pickedExpressionImage });
        // End the game after the certain number of repetion.
        actualNumberOfStepsToGameEnd--;
        if (actualNumberOfStepsToGameEnd === 0 ) {
          clearInterval(gameInterval);
          // Save the data about success rate.
          gamesHistory.push(stepsHistory);
          setView(beforeGameScreen);
          setLastGameSuccessRate();
          
        }
      },
      delayBetweenSteps
    )
  }

  const getActualStepIndex = () => stepsHistory.length - 1;


  const evaluateNBackStep = () => {
    const actualStepIndex = getActualStepIndex();
    console.log(stepsHistory);
    return stepsHistory[actualStepIndex - nBackLevel].pickedExpressionImage ===
    stepsHistory[actualStepIndex].pickedExpressionImage;
  }



  // Sensing key.
  document.onkeypress = ({ key }) => {
    const actualStepIndex = getActualStepIndex();
    // Evaluate if key was pressed at matching expression.
    console.log(stepsHistory[actualStepIndex].evaluation);
    key === " " && (typeof stepsHistory[actualStepIndex].evaluation === "undefined") && (() => {
      const evaluation = evaluateNBackStep();
      
      // Storing score.
      stepsHistory[actualStepIndex] = { ...stepsHistory[actualStepIndex], evaluation };
      console.log(stepsHistory);
    })()
    
  }



</script>

</html>